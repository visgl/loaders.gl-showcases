import { getFrustumBounds } from "./frustum-utils";

const planes = {
  left: {
    distance: -166.263660956433,
    normal: [-0.913811548620257, -0.2871832634470952, 0.28718326344709527],
  },
  right: {
    distance: -10.306489991909089,
    normal: [0.913811548620257, -0.2871832634470952, 0.28718326344709527],
  },
  bottom: {
    distance: -274.9991542255675,
    normal: [0, -0.894427190999916, -0.44721359549995787],
  },
  top: {
    distance: 137.5180017451667,
    normal: [0, 0.44721359549995804, 0.8944271909999159],
  },
  near: {
    distance: -217.37937809385937,
    normal: [0, -0.7071067811865475, 0.7071067811865476],
  },
  far: {
    distance: 217.4356350329022,
    normal: [0, 0.7071067811865476, -0.7071067811865476],
  },
};

const viewport = {
  id: "WebMercatorViewport",
  x: 0,
  y: 0,
  width: 800,
  height: 600,
  _frustumPlanes: {
    left: {
      distance: -166.263660956433,
      normal: [-0.913811548620257, -0.2871832634470952, 0.28718326344709527],
    },
    right: {
      distance: -10.306489991909089,
      normal: [0.913811548620257, -0.2871832634470952, 0.28718326344709527],
    },
    bottom: {
      distance: -274.9991542255675,
      normal: [0, -0.894427190999916, -0.44721359549995787],
    },
    top: {
      distance: 137.5180017451667,
      normal: [0, 0.44721359549995804, 0.8944271909999159],
    },
    near: {
      distance: -217.37937809385937,
      normal: [0, -0.7071067811865475, 0.7071067811865476],
    },
    far: {
      distance: 217.4356350329022,
      normal: [0, 0.7071067811865476, -0.7071067811865476],
    },
  },
  isGeospatial: true,
  zoom: 14.5,
  scale: 23170.475005920787,
  distanceScales: {
    unitsPerMeter: [
      0.000015428018726804885, 0.000015428018726804885, 0.000015428018726804885,
    ],
    metersPerUnit: [64817.136776129526, 64817.136776129526, 64817.136776129526],
    unitsPerDegree: [
      1.4222222222222223, 1.7155099712055546, 0.000015428018726804885,
    ],
    degreesPerUnit: [0.703125, 0.5829170432027636, 64817.136776129526],
  },
  focalDistance: 1.5,
  position: [0, 0, 0],
  meterOffset: [0, 0, 0],
  longitude: -120,
  latitude: 34,
  center: [85.33333333333334, 307.4721342118149, 0],
  viewMatrixUncentered: [
    38.617458343201314, 0, 0, 0, 0, 27.30666666666667, -27.30666666666666, 0, 0,
    27.30666666666666, 27.30666666666667, 0, 0, 0, -1.5, 1,
  ],
  viewMatrix: [
    38.617458343201314, 0, 0, 0, 0, 27.30666666666667, -27.30666666666666, 0, 0,
    27.30666666666666, 27.30666666666667, 0, -3295.3564452865126,
    -8396.039078210626, 8394.539078210622, 1,
  ],
  projectionMatrix: [
    2.25, 0, 0, 0, 0, 3, 0, 0, 0, 0, -1.092059838895282, -1, 0, 0,
    -0.2092059838895282, 0,
  ],
  viewProjectionMatrix: [
    86.88928127220295, 0, 0, 0, 0, 81.92, 29.82051400076716, 27.30666666666666,
    0, 81.91999999999999, -29.82051400076717, -27.30666666666667,
    -7414.552001894654, -25188.117234631878, -9167.548199334731,
    -8394.539078210622,
  ],
  viewMatrixInverse: [
    0.02589502372509329, 0, 0, 0, 0, 0.018310546875, 0.018310546874999997, 0, 0,
    -0.018310546874999997, 0.018310546875, 0, 85.33333333333333,
    307.4446683915023, 0.02746582031252901, 0.9999999999999999,
  ],
  cameraPosition: [85.33333333333333, 307.4446683915023, 0.02746582031252901],
  pixelProjectionMatrix: [
    34755.71250888118, 0, 0, 0, 10922.666666666664, -16384, 29.82051400076716,
    27.30666666666666, -10922.666666666668, -32767.999999999996,
    -29.82051400076717, -27.30666666666667, -6323636.432042111,
    5038073.446926378, -9167.548199334731, -8394.539078210622,
  ],
  viewportMatrix: [400, 0, 0, 0, 0, -300, 0, 0, 0, 0, 1, 0, 400, 300, 0, 1],
  pixelUnprojectionMatrix: [
    0.000028772248583388125, 0, 0, 0, 0, -0.000020345052083298777,
    -0.000020345052083333332, 0, -407.89145581041095, -1469.5787504456123,
    -0.13128601678501592, -4.779977997778253, 445.4303686196462,
    1604.8923475180652, 0.1311651550895291, 5.2200220021767105,
  ],
  pitch: 45,
  bearing: 0,
  altitude: 1.5,
  fovy: 36.86989764584402,
  orthographic: false,
  _subViewports: null,
  _pseudoMeters: false,
  getFrustumPlanes: () => planes,
  unprojectPosition: ([x, y, z]) => [x, y, z],
};

const expectedBounds = [
  {
    source: [85.33218244339, 307.4471097977524, 0.026245117187529927],
    target: [85.3344842232767, 307.4471097977524, 0.026245117187529927],
    color: [255, 0, 128],
  },
  {
    source: [85.3344842232767, 307.4471097977524, 0.026245117187529927],
    target: [85.3344842232767, 307.44588909462743, 0.025024414062601343],
    color: [255, 0, 128],
  },
  {
    source: [85.3344842232767, 307.44588909462743, 0.025024414062601343],
    target: [85.33218244339, 307.44588909462743, 0.025024414062601343],
    color: [255, 0, 128],
  },
  {
    source: [85.33218244339, 307.44588909462743, 0.025024414062601343],
    target: [85.33218244339, 307.4471097977524, 0.026245117187529927],
    color: [255, 0, 128],
  },
  {
    source: [85.30717935937099, 307.5001493485336, -0.00027465820310631],
    target: [85.35948730729574, 307.5001493485336, -0.00027465820310631],
    color: [128, 0, 255],
  },
  {
    source: [85.35948730729574, 307.5001493485336, -0.00027465820310631],
    target: [85.35948730729572, 307.4724088700181, -0.028015136718701088],
    color: [128, 0, 255],
  },
  {
    source: [85.35948730729572, 307.4724088700181, -0.028015136718701088],
    target: [85.30717935937098, 307.4724088700181, -0.028015136718701088],
    color: [128, 0, 255],
  },
  {
    source: [85.30717935937098, 307.4724088700181, -0.028015136718701088],
    target: [85.30717935937099, 307.5001493485336, -0.00027465820310631],
    color: [128, 0, 255],
  },
  {
    source: [85.33218244339, 307.4471097977524, 0.026245117187529927],
    target: [85.30717935937099, 307.5001493485336, -0.00027465820310631],
    color: [0, 128, 255],
  },
  {
    source: [85.33218244339, 307.44588909462743, 0.025024414062601343],
    target: [85.30717935937098, 307.4724088700181, -0.028015136718701088],
    color: [0, 128, 255],
  },
  {
    source: [85.3344842232767, 307.4471097977524, 0.026245117187529927],
    target: [85.35948730729574, 307.5001493485336, -0.00027465820310631],
    color: [0, 128, 255],
  },
  {
    source: [85.3344842232767, 307.44588909462743, 0.025024414062601343],
    target: [85.35948730729572, 307.4724088700181, -0.028015136718701088],
    color: [0, 128, 255],
  },
];

describe("Frustum Utiils", () => {
  test("Should get frustumBounds", () => {
    const bounds = getFrustumBounds(viewport);
    expect(bounds).toBeDefined();
    expect(bounds).toStrictEqual(expectedBounds);
  });
});
